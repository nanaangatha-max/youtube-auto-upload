name: Auto Upload YouTube Video

on:
  schedule:
    # Run once a week: Monday 8 AM and Tuesday 6 PM
    - cron: "0 2 * * 1"   # 8 AM IST (= 2 AM UTC)
    - cron: "30 12 * * 2" # 6 PM IST (= 12:30 PM UTC)
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install moviepy google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Generate video
        run: python generate_video.py

      - name: Upload video to YouTube
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        run: |
          python <<EOF
          from googleapiclient.discovery import build
          from google.oauth2.credentials import Credentials

          creds = Credentials(
              None,
              refresh_token="${{ env.REFRESH_TOKEN }}",
              token_uri="https://oauth2.googleapis.com/token",
              client_id="${{ env.CLIENT_ID }}",
              client_secret="${{ env.CLIENT_SECRET }}",
              scopes=["https://www.googleapis.com/auth/youtube.upload"]
          )

          youtube = build("youtube", "v3", credentials=creds)
          request = youtube.videos().insert(
              part="snippet,status",
              body={
                  "snippet": {"title": "Rolls Royce Facts", "description": "AI auto video upload"},
                  "status": {"privacyStatus": "public"}
              },
              media_body="video.mp4"
          )
          request.execute()
          EOF
